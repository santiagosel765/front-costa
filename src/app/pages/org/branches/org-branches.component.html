<nz-card nzBordered>
  <div class="branch-header">
    <div>
      <h3>Sucursales</h3>
      <p>Administra sucursales y datos de ubicación operativa.</p>
    </div>
    <button *ngIf="canWrite()" nz-button nzType="primary" (click)="openCreate()">
      <span nz-icon nzType="plus"></span>
      Nueva sucursal
    </button>
  </div>

  <app-data-table
    [columns]="columns"
    [data]="rows()"
    [loading]="loading()"
    [error]="error()"
    [total]="total()"
    [pageIndex]="tableState.snapshot.page"
    [pageSize]="tableState.snapshot.size"
    [searchValue]="tableState.snapshot.q"
    [emptyMessage]="emptyMessage"
    searchPlaceholder="Buscar sucursal"
    (pageChange)="onPageChange($event)"
    (searchChange)="onSearchChange($event)"
    (action)="handleAction($event)"
  ></app-data-table>

  <div *ngIf="!loading() && rows().length === 0 && tableState.snapshot.q" class="search-empty-actions">
    <button nz-button nzType="default" (click)="clearSearch()">
      <span nz-icon nzType="close-circle"></span>
      Limpiar filtro
    </button>
  </div>
</nz-card>

<nz-modal
  [nzVisible]="isModalVisible()"
  [nzTitle]="editingId() ? 'Editar sucursal' : 'Nueva sucursal'"
  [nzOkLoading]="saving()"
  [nzOkDisabled]="form.invalid"
  (nzOnCancel)="closeModal()"
  (nzOnOk)="save()"
>
  <ng-container *nzModalContent>
    <form [formGroup]="form" class="branch-form">
      <label>Código *</label>
      <input nz-input formControlName="code" />
      <small class="field-error" *ngIf="codeError">{{ codeError }}</small>

      <label>Nombre *</label>
      <input nz-input formControlName="name" />
      <small class="field-error" *ngIf="nameError">{{ nameError }}</small>

      <label>Descripción</label>
      <textarea nz-input formControlName="description" rows="2"></textarea>

      <div class="location-grid">
        <div>
          <label>Teléfono</label>
          <input nz-input formControlName="phone" />
        </div>
        <div>
          <label>Email</label>
          <input nz-input type="email" formControlName="email" />
        </div>
      </div>

      <label>Encargado</label>
      <input nz-input formControlName="managerName" />

      <h4>Ubicación</h4>
      <label>Dirección línea 1</label>
      <input nz-input formControlName="addressLine1" />

      <label>Dirección línea 2</label>
      <input nz-input formControlName="addressLine2" />

      <div class="location-grid">
        <div>
          <label>Ciudad</label>
          <input nz-input formControlName="city" />
        </div>
        <div>
          <label>Depto / Estado</label>
          <input nz-input formControlName="state" />
        </div>
        <div>
          <label>País</label>
          <input nz-input formControlName="country" />
        </div>
      </div>

      <label>Código postal</label>
      <input nz-input formControlName="postalCode" />

      <div class="location-grid">
        <div>
          <label>Latitud</label>
          <input nz-input type="number" formControlName="latitude" />
        </div>
        <div>
          <label>Longitud</label>
          <input nz-input type="number" formControlName="longitude" />
        </div>
      </div>

      <label>Notas de ubicación</label>
      <textarea nz-input formControlName="locationNotes" rows="2"></textarea>

      <div class="switch-row">
        <label>Activo</label>
        <nz-switch formControlName="active"></nz-switch>
      </div>
    </form>
  </ng-container>
</nz-modal>
