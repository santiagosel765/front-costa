<div class="org-page-container">
  <app-page-header
    [breadcrumbs]="breadcrumbs"
    title="Sucursales"
    subtitle="Administra la estructura operativa de sucursales para inventario y asignaciones."
  >
    <button headerActions nz-button nzType="default" (click)="goAssignments()">
      <span nz-icon nzType="interaction"></span>
      Asignaciones
    </button>
    <button *ngIf="canWrite()" headerActions nz-button nzType="primary" (click)="openCreate()">
      <span nz-icon nzType="plus"></span>
      Nueva sucursal
    </button>
  </app-page-header>

  <nz-card nzBordered>
    <app-data-table
      [columns]="columns"
      [data]="rows()"
      [loading]="loading()"
      [error]="error()"
      [total]="total()"
      [pageIndex]="tableState.snapshot.page"
      [pageSize]="tableState.snapshot.size"
      [searchValue]="tableState.snapshot.q"
      [emptyMessage]="emptyMessage"
      searchPlaceholder="Buscar sucursal"
      (pageChange)="onPageChange($event)"
      (searchChange)="onSearchChange($event)"
      (action)="handleAction($event)"
    ></app-data-table>

    <div *ngIf="!loading() && rows().length === 0 && tableState.snapshot.q" class="search-empty-actions">
      <button nz-button nzType="default" (click)="clearSearch()">
        <span nz-icon nzType="close-circle"></span>
        Limpiar filtro
      </button>
    </div>

    <div *ngIf="!loading() && rows().length === 0 && !tableState.snapshot.q && canWrite()" class="search-empty-actions">
      <button nz-button nzType="primary" (click)="openCreate()">
        <span nz-icon nzType="plus"></span>
        Crear primera sucursal
      </button>
    </div>
  </nz-card>
</div>

<nz-modal [nzVisible]="isModalVisible()" [nzTitle]="editingId() ? 'Editar sucursal' : 'Nueva sucursal'" [nzFooter]="modalFooter" (nzOnCancel)="closeModal()">
  <ng-container *nzModalContent>
    <form [formGroup]="form" class="branch-form">
      <label>Código *</label>
      <input nz-input formControlName="code" />
      <small class="field-error" *ngIf="codeError">{{ codeError }}</small>

      <label>Nombre *</label>
      <input nz-input formControlName="name" />
      <small class="field-error" *ngIf="nameError">{{ nameError }}</small>

      <label>Dirección</label>
      <textarea nz-input formControlName="address" rows="2"></textarea>

      <label>Descripción</label>
      <textarea nz-input formControlName="description" rows="2"></textarea>

      <div class="switch-row">
        <label>Activo</label>
        <nz-switch formControlName="active"></nz-switch>
      </div>
    </form>
  </ng-container>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="closeModal()" [disabled]="saving()">Cancelar</button>
    <button nz-button nzType="primary" (click)="save()" [disabled]="form.invalid || saving()" [nzLoading]="saving()">Guardar</button>
  </ng-template>
</nz-modal>
