<div class="org-page-container">
  <app-page-header
    [breadcrumbs]="breadcrumbs"
    title="Asignaciones Usuario ↔ Sucursal"
    subtitle="Consulta y administra la relación entre usuarios y sucursales activas."
  >
    <button headerActions nz-button nzType="default" (click)="goBranches()">
      <span nz-icon nzType="apartment"></span>
      Sucursales
    </button>
    <button headerActions nz-button nzType="primary" [disabled]="!canCreate()" (click)="openCreateModal()">
      <span nz-icon nzType="plus"></span>
      Nueva asignación
    </button>
  </app-page-header>

  <nz-card nzBordered>
    <div class="filters" [formGroup]="filtersForm">
      <nz-select nzAllowClear nzShowSearch nzPlaceHolder="Usuario" formControlName="userId">
        <nz-option *ngFor="let user of users()" [nzLabel]="user.label" [nzValue]="user.id"></nz-option>
      </nz-select>

      <nz-select nzAllowClear nzShowSearch nzPlaceHolder="Sucursal" formControlName="branchId">
        <nz-option *ngFor="let branch of branchOptions()" [nzLabel]="branch.label" [nzValue]="branch.value"></nz-option>
      </nz-select>

      <div class="filters-actions">
        <button nz-button nzType="default" (click)="applyFilters()">
          <span nz-icon nzType="search"></span>
          Filtrar
        </button>
        <button nz-button nzType="default" (click)="clearFilters()">
          Limpiar
        </button>
      </div>
    </div>

    <div *ngIf="initialized() && !loading() && !catalogsLoading() && rows().length === 0" class="selection-hint">
      <span nz-icon nzType="inbox"></span>
      No hay asignaciones para este criterio.
    </div>

    <nz-table [nzData]="rows()" [nzLoading]="loading()" [nzFrontPagination]="false" [nzShowPagination]="false" nzBordered>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Sucursal</th>
            <th>Activo</th>
            <th>Actualizado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of rows()">
            <td>{{ item.userLabel }}</td>
            <td>{{ item.branchLabel }}</td>
            <td>
              <nz-tag [nzColor]="item.active ? 'green' : 'red'">{{ item.active ? 'Activo' : 'Inactivo' }}</nz-tag>
            </td>
            <td>{{ formatDate(item.updatedAt) }}</td>
            <td>
              <button nz-button nzType="link" nzDanger [disabled]="!canDelete()" (click)="confirmDelete(item)">
                <span nz-icon nzType="delete"></span>
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </nz-table>

    <nz-pagination
      *ngIf="total() > 0"
        class="table-pagination"
        [nzTotal]="total()"
        [nzPageIndex]="pageIndex()"
        [nzPageSize]="pageSize()"
        [nzShowSizeChanger]="true"
        [nzShowQuickJumper]="true"
        [nzShowTotal]="totalTpl"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
      ></nz-pagination>
  </nz-card>
</div>

<ng-template #totalTpl let-total let-range="range">
  Mostrando {{ range[0] }}-{{ range[1] }} de {{ total }}
</ng-template>

<nz-modal [nzVisible]="modalVisible()" nzTitle="Nueva asignación" [nzFooter]="modalFooter" (nzOnCancel)="closeCreateModal()">
  <ng-container *nzModalContent>
    <form [formGroup]="createForm" class="create-form">
      <label>Usuario *</label>
      <nz-select nzShowSearch nzPlaceHolder="Seleccionar usuario" formControlName="userId">
        <nz-option *ngFor="let user of users()" [nzLabel]="user.label" [nzValue]="user.id"></nz-option>
      </nz-select>
      <small class="field-error" *ngIf="createForm.controls.userId.invalid && createForm.controls.userId.touched">El usuario es obligatorio.</small>

      <label>Sucursal *</label>
      <nz-select nzShowSearch nzPlaceHolder="Seleccionar sucursal" formControlName="branchId">
        <nz-option *ngFor="let branch of branchOptions()" [nzLabel]="branch.label" [nzValue]="branch.value"></nz-option>
      </nz-select>
      <small class="field-error" *ngIf="createForm.controls.branchId.invalid && createForm.controls.branchId.touched">La sucursal es obligatoria.</small>
    </form>
  </ng-container>

  <ng-template #modalFooter>
    <button nz-button nzType="default" [disabled]="saving()" (click)="closeCreateModal()">Cancelar</button>
    <button nz-button nzType="primary" [disabled]="createForm.invalid || saving()" [nzLoading]="saving()" (click)="createAssignment()">Guardar</button>
  </ng-template>
</nz-modal>
